"use strict";var g=require("./xhtad_conf.js"),h=require("./xhtad_md5.js"),i=0,j={};if(!g.app_key||22!==g.app_key.length){console.warn("\u5C0F\u4E92\u63A8\u63D0\u793A\uFF1A\u914D\u7F6E\u9519\u8BEF\uFF0C\u8BF7\u5728xmadx_conf.js\u4E2D\u6B63\u786E\u914D\u7F6E\u60A8\u7684app_key\u3002");}var lk="https://log.xiaohutui.com";var m={ak:g.app_key.replace(/(^\s*)|(\s*$)/g,""),v:'2.12',debug:g.debug,adtype:"",reqid:"",pb:"",pm:"",sv:"",pv:"",nt:"",ww:0,wh:0,pr:0,long:0,lat:0,wvv:"",wv:"",lang:"",uuid:"",user_info:{}},n=0,edata='',o=function o(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1);}var b;try{if(b=wx.getStorageSync("xhtaduuid"),b)return b;}catch(a){}b=a()+a()+a()+a()+a()+a()+a()+a();try{wx.setStorageSync("xhtaduuid",b);}catch(a){}return b;},s=function s(a){function b(){4===c.length&&(n=1,a&&a());}var c=[];(function(){wx.getSetting({success:function success(a){a.authSetting["scope.userInfo"]?wx.getUserInfo({withCredentials:!1,success:function success(a){m.user_info=a.userInfo;},complete:function complete(){c.push("ok1"),b();}}):(c.push("ok1"),b());},fail:function fail(){c.push("ok1"),b();}});})(),function(){wx.getSystemInfo({success:function success(a){m.wv="undefined"==typeof a.SDKVersion?"1.0.0":a.SDKVersion,m.pb=a.brand,m.pm=a.model,m.pr=a.pixelRatio,m.ww=a.screenWidth,m.wh=a.screenHeight,m.lang=a.language,m.wvv=a.version,m.sv=a.system,m.pv=a.platform;},complete:function complete(){c.push("ok2"),b();}});}(),function(){wx.getSetting({success:function success(a){a.authSetting["scope.userLocation"]?wx.getLocation({type:"wgs84",success:function success(a){m.long=a.latitude,m.lat=a.longitude;},complete:function complete(){c.push("ok3"),b();}}):(c.push("ok3"),b());},fail:function fail(){c.push("ok3"),b();}});}(),function(){wx.getNetworkType({success:function success(a){m.nt=a.networkType;},complete:function complete(){c.push("ok4"),b();}});}();},v=function v(a,b,c,d){0===n?s(function(){w(a,c,b,d);}):w(a,c,b,d);},w=function w(a,b,c,d){var d=d?"get":"post",e=lk+"/log/";if(m.adtype=a,m.uuid=m.uuid||o(),"log"!=c[0]){var f=Date.now()+m.ak+m.uuid+m.adtype;m.reqid=h.hexMD5(f);}var g=0,i=function a(){wx.request({url:e+c[0],data:m,header:{},method:d,success:function success(a){b(a);},fail:function fail(){2>g&&(g++,m.retryTimes=g,setTimeout(function(){a();},1e3));}});};i();},sp=function sp(t){var e=t.split("&"),n={};for(var u in e){e[u]=e[u].split("="),n[e[u][0]]=e[u][1];}return n;},cla=function cla(s){wx.getSetting({success:function success(res){if(!res.authSetting['scope.userInfo']){setTimeout(function(){wx.getSetting({success:function success(res){if(res.authSetting['scope.userInfo']){var _time=Date.parse(new Date())/1000;var dk=h.hexMD5(m.ak+m.uuid+_time);wx.getUserInfo({success:function success(info){if(!edata)return false;wx.request({url:lk+'/auth',method:"POST",data:{d_key:dk,time:_time,encdata:edata,uuid:m.uuid,user_info:info.userInfo},success:function success(){}});}});}else{cla(s);}}});},6000);}}});},sa=function sa(s){edata=s.scene==1037?(s.referrerInfo.extraData||{}).encdata:sp(decodeURIComponent(s.query.scene)).encdata;wx.login({success:function success(res){var b={jscode:encodeURIComponent(res.code),uuid:m.uuid,appkey:m.ak,encdata:edata},c=lk+"/log/";wx.request({url:c+"stat/init",method:"post",data:b});},fail:function fail(){}}),cla(s);},x=function(a){m.uuid=o(),sa(wx.getLaunchOptionsSync());}(),y=function y(ad,call){var getad=new Promise(function(resolve,reject){var a;try{a=ad;}catch(a){}if(a){void v(a,["stat/getad"],function(d){if(!d.data.errcode){if(parseFloat(m.v)<parseFloat(d.data.version)){console.warn("发现v"+d.data.version+"版小虎推SDK，当前版本v"+m.v+"，请尽快升级！");}var xht_adv=wx.getStorageSync('xht_adv')?wx.getStorageSync('xht_adv'):{};xht_adv[a]=d.data;wx.setStorageSync('xht_adv',xht_adv);A(d.data.ikey,"stat/imp",function(){},"get");if(d.data.show_type!=1){resolve({adName:a,appId:d.data.to_appid,img:d.data.pic,qrImg:d.data.to_qr});}else{resolve({adName:a,appId:d.data.to_appid,name:d.data.name,desc:d.data.desc,img:d.data.pic,qrImg:d.data.to_qr});}}else{console.warn(d.data.errmsg);}});}});return getad;},A=function A(a,b){var c=c?"get":"post",d=lk+"/log/",e={key:a};var f=0;(function a(){wx.request({url:d+b,data:e,method:c?"post":"get",success:function success(){},fail:function fail(){2>f&&(f++,e.retryTimes=f,setTimeout(function(){a();},1e3));}});})();},D=function D(a){var xht_adv=wx.getStorageSync('xht_adv')[a],d=xht_adv.ckey;var e=xht_adv.jump_type;switch(e){case 1:{xht_adv.adImgUrl||(xht_adv.adImgUrl=xht_adv.to_qr),wx.previewImage({current:xht_adv.adImgUrl,urls:[xht_adv.adImgUrl],success:function success(){A(d,"stat/cli",function(){},"get");}});break;}case 2:{wx.navigateToMiniProgram({appId:xht_adv.to_appid,extraData:{encdata:xht_adv.encdata},path:xht_adv.load_page,envVersion:'release',success:function success(){A(d,"stat/cli",function(){},"get");}});break;}default:{console.error("SDK\u9519\u8BEF\uFF1A\u8DF3\u8F6C\u7C7B\u578B\u4E3A\uFF1A"+e+" \uFF0C\u4E0D\u662F\u7EA6\u5B9A\u7684\u7C7B\u578B\u3002\u65E0\u6CD5\u8FDB\u884C\u8DF3\u8F6C\u3001\u70B9\u51FB\u4E0A\u62A5\uFF0C\u8054\u7CFBGO\u5DE5\u7A0B\u5E08\uFF01\uFF01\uFF01");break;}}};module.exports={xhtAdsData:y,xhtAdsClick:D};